#!/bin/bash
# Wrapper script to ssh to a robot. It starts a private instance of ssh-agent
# that makes the user's github key (and only that key) available during the
# session. It also environment variables for the user's git identity, read
# from the local machine's ~/.gituser file.
# Usage:  sshbar [-v] <n>
# -v Use IP address instead of name (10.10.32.103 instead of bar3)
# n  bar<n> or IP address or 10.10.32.10<n> (with -v)
# Examples:
# sshbar 3
#     ssh to bar@bar3
# sshbar -v 3
#     ssh to bar@10.210.232.103
# sshbar -a 3
#     ssh to bar@172.210.220.103
# sshbar 10.10.39.209
#     ssh to bar@10.10.39.209

function valid_ip()
{
    local  ip=$1
    local  stat=1

    if [[ $ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
        OIFS=$IFS
        IFS='.'
        ip=($ip)
        IFS=$OIFS
        [[ ${ip[0]} -le 255 && ${ip[1]} -le 255 \
            && ${ip[2]} -le 255 && ${ip[3]} -le 255 ]]
        stat=$?
    fi
    return $stat
}

function usage() {
    echo "Usage:  sshbar [-v][-a][-h] <n>"
    echo " -v Use VPN IP address instead of name (10.210.232.103 instead of bar3)"
    echo " -a Use AWS VPN IP address instead of name (172.210.220.103 instead of bar3)"
    echo " -h Display this help message"
    echo " n = bar<n> or IP address"
    echo " Examples:"
    echo " sshbar 3"
    echo "     ssh to bar@bar3"
    echo " sshbar -v 3"
    echo "     ssh to bar@10.210.232.103"
    echo " sshbar -a 3"
    echo "     ssh to bar@172.210.220.103"
    echo " sshbar 10.10.39.209"
    echo "     ssh to bar@10.10.39.209"
    exit 1
}


vpn=0
avpn=0
while getopts ":vah" opt; do
  case $opt in
    v)
        vpn=1
        shift $((OPTIND-1))
      ;;
    a)
        avpn=1
        shift $((OPTIND-1))
      ;;
    \?)
        echo "Invalid option: -$OPTARG" >&2
        usage
      ;;
    h)
      usage
      ;;
  esac
done

if [ -z "$1" ] ; then
    usage
fi

host="${@: -1}"
if valid_ip ${@: -1}; then
    host="${@: -1}"
elif [[ ${host} =~ ^[0-9]+$ ]]; then
    if [ $vpn -eq 1 ] ; then
        host=10.210.232.$((100+$host));
    elif [ $avpn -eq 1 ] ; then
        host=172.21.220.$((100+$host));
    else host=bar${host};
    fi
fi

uds_addr=$(mktemp --dry-run $XDG_RUNTIME_DIR/ssh-agent-XXXXXX)
id_file=~/.ssh/id_rsa-$(hostname)-github
git_email=$(sed -n -e 's/^\s\+email\s\?=\s\?//p' < ~/.gituser)
git_name=$(sed -n -e 's/^\s\+name\s\?=\s\?//p' < ~/.gituser | sed -e 's/\s/\\ /')

exec ssh-agent -a $uds_addr ssh -X -t -A -l bar \
    -o IdentityFile=$id_file -o AddKeysToAgent=yes -l bar ${host} \
    GIT_AUTHOR_EMAIL="${git_email}" \
    GIT_COMMITTER_EMAIL="${git_email}" \
    GIT_AUTHOR_NAME="${git_name}" \
    GIT_COMMITTER_NAME="${git_name}" \
    EDITOR=emacs \
    zsh -l
